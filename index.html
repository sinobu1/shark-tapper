<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Shark Tapper</title>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Стили игры -->
  <style>
    /* === ГЛОБАЛЬНЫЕ СТИЛИ === */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%; height: 100%; overflow: hidden;
      background: linear-gradient(160deg, #e8ecef, #cfd8dc);
      font-family: 'Segoe UI', sans-serif;
      touch-action: manipulation;
    }

    /* === ЭКРАН ЗАГРУЗКИ === */
    .loading-screen {
      position: fixed; width: 100%; height: 100%; background: #fff; z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .loading-screen img { max-width: 80%; }
    .loading-screen span { font-size: 20px; margin-top: 12px; color: #333; }

    /* === ОСНОВНОЙ ИГРОВОЙ КОНТЕЙНЕР === */
    .game-container {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: 90vw; max-width: 400px; height: 90vh; max-height: 700px;
      background: #ffffff; border: 4px solid #d0d0d0; border-radius: 24px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); padding: 20px;
      display: flex; flex-direction: column; align-items: center; justify-content: space-between;
    }

    /* === ЭЛЕМЕНТЫ ВЕРХНЕГО БЛОКА === */
    .balance { color: #111; font-size: 22px; font-weight: bold; }
    .level { color: #333; font-size: 16px; margin-bottom: 4px; }

    /* === КНОПКА ИЗОБРАЖЕНИЯ === */
    .tap-image {
      max-width: 100%; cursor: pointer; transition: transform 0.1s; border-radius: 16px;
    }
    .tap-animation { animation: tapPulse 0.2s ease; }

    @keyframes tapPulse {
      0% { transform: scale(1); }
      50% { transform: scale(0.9); }
      100% { transform: scale(1); }
    }

    /* === АНИМАЦИЯ ПРИ КЛИКЕ === */
    .floating-text {
      position: absolute; font-size: 18px; color: #3cba54; font-weight: 700;
      animation: floatUp 1s ease-out forwards; pointer-events: none;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-50px); }
    }

    /* === КНОПКИ МЕНЮ === */
    .menu-buttons { display: flex; gap: 12px; }
    .shop-button {
      background: #3cba54; color: white; border: none; padding: 10px 16px;
      border-radius: 10px; cursor: pointer; font-size: 16px;
    }

    /* === МОДАЛКИ МАГАЗИНА И БУСТЕРОВ === */
    .shop-modal, .booster-modal {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.95); display: none;
      flex-direction: column; align-items: center; justify-content: center; padding: 20px; z-index: 10;
    }
    .shop-item, .booster-item { margin: 10px; text-align: center; }
    .shop-item img { width: 100px; height: auto; border-radius: 12px; }
    .shop-item button, .booster-item button {
      margin-top: 5px; padding: 6px 12px; border: none;
      background: #333; color: white; border-radius: 6px; cursor: pointer;
    }
  </style>
</head>
<body>

<!-- === ЭКРАН ЗАГРУЗКИ === -->
<div class="loading-screen" id="loading">
  <img src="w1.png" alt="Loading..." />
  <span>Приключение 2025</span>
</div>

<!-- === ОСНОВНОЙ ИГРОВОЙ КОНТЕЙНЕР === -->
<div class="game-container" style="display:none" id="gameContainer">
  <div class="level" id="levelDisplay">Уровень 1 (XP: 0/10)</div>
  <div class="balance" id="tokenCount">0 токенов</div>
  <img id="tapImage" class="tap-image" src="shark.png" onclick="handleTap()" alt="Shark" />

  <div class="menu-buttons">
    <button class="shop-button" onclick="openShop()">Магазин</button>
    <button class="shop-button" onclick="openBoosters()">Бустеры</button>
  </div>
  <button class="shop-button" id="endButton" onclick="Telegram.WebApp.close()" style="display: none;">Завершить</button>
</div>

<!-- === ИГРОВАЯ ЛОГИКА === -->
<script>
  // === НАСТРОЙКИ И СОСТОЯНИЕ ===
  const dbUrl = 'https://tralalero-fec07-default-rtdb.firebaseio.com';
  let userId = null;

  let balance = 0;
  let xp = 0;
  let level = 1;
  let xpToNext = 10;
  let incomePerTap = 1;
  let autoTap = 0;

  let currentSkin = 'default';
  let ownedSkins = { default: true };
  let ownedBoosters = { 1: false, 2: false, 3: false };

  const tokenCount = document.getElementById('tokenCount');
  const levelDisplay = document.getElementById('levelDisplay');
  const tapImage = document.getElementById('tapImage');
  const loadingScreen = document.getElementById('loading');
  const gameContainer = document.getElementById('gameContainer');

  const skinPaths = {
    default: 'shark.png?v=1',
    skin2: 'shark_skin2.png?v=1',
    skin3: 'shark_skin1.png?v=1'
  };

  function updateSkin() {
    tapImage.src = skinPaths[currentSkin] || skinPaths.default;
  }

  function updateUI() {
    tokenCount.textContent = `${balance} токенов`;
    levelDisplay.textContent = `Уровень ${level} (XP: ${xp}/${xpToNext})`;
  }

  function gainXP(amount) {
    xp += amount;
    while (xp >= xpToNext) {
      xp -= xpToNext;
      level++;
      xpToNext = Math.floor(xpToNext * 1.5);
      incomePerTap += 1;
    }
    updateUI();
  }

  function handleTap() {
    balance += incomePerTap;
    gainXP(1);
    updateUI();
    showFloatingText(`+${incomePerTap}`);
    tapImage.classList.add("tap-animation");
    setTimeout(() => tapImage.classList.remove("tap-animation"), 200);
    saveProgress();
  }

  function startAutoTap() {
    setInterval(() => {
      if (autoTap > 0) {
        balance += autoTap;
        updateUI();
        saveProgress();
      }
    }, 1000);
  }

  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      loadingScreen.style.display = 'none';
      gameContainer.style.display = 'flex';
      updateSkin(); // <=== добавлено для загрузки изображения скина
    }, 5000);

    if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();

      const endBtn = document.getElementById('endButton');
      if (endBtn) {
        endBtn.style.display = 'inline-block';
      }

      userId = Telegram.WebApp.initDataUnsafe?.user?.id?.toString();
      if (userId) {
        loadProgress();
        startAutoTap();
      } else {
        alert("Не удалось получить userId из Telegram Web App.");
      }
    }
  });
</script>
</body>
</html>
