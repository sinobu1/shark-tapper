<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0a0a2a" />
    <title>Акула Тапалка - Главная</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --size: min(70vw, 280px);
            --inner1: calc(var(--size) * 0.85);
            --inner2: calc(var(--size) * 0.71);
            --neon: #00f2fe;
            --neon-pink: #ff00ff;
            --neon-purple: #9d00ff;
            --card-bg: rgba(50, 30, 100, 0.3);
            --card-border: rgba(150, 100, 255, 0.4);
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --card-radius: 30px;
            --gem-color: #e91e63;
            --ore-color: #ff9800;
            --energy-color: #4caf50;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a2a 0%, #2a0a2a 50%, #000018 100%);
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .container {
            text-align: center;
            padding: 24px;
            max-width: 420px;
            width: 100%;
            background: var(--card-bg);
            border-radius: var(--card-radius);
            border: 1px solid rgba(0,255,255,0.2);
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-color: var(--card-border);
            position: relative;
        }

        /* Floating particles background */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            pointer-events: none;
        }

        /* Currency styles */
        .currency {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(0, 255, 255, 0.08);
            border-radius: 16px;
            backdrop-filter: blur(6px);
            flex-wrap: wrap;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .currency span {
            display: flex;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            padding: 0 4px;
            transition: all 0.3s ease;
        }

        .currency span:hover {
            transform: scale(1.05);
        }

        .currency img {
            width: 20px;
            height: 20px;
            margin-right: 4px;
        }

        .currency .coin-count {
            color: var(--neon);
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }

        .currency .gem-count {
            color: var(--gem-color);
            text-shadow: 0 0 5px rgba(233, 30, 99, 0.5);
        }

        .currency .ore-count {
            color: var(--ore-color);
            text-shadow: 0 0 5px rgba(255, 152, 0, 0.5);
        }

        .currency .energy-count {
            color: var(--energy-color);
            text-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }

        .currency .gem-icon {
            width: 24px;
            height: 24px;
            margin-right: 4px;
        }

        .currency .ore-icon {
            width: 20px;
            height: 20px;
            margin-right: 4px;
        }

        .currency .energy-icon {
            width: 20px;
            height: 20px;
            margin-right: 4px;
        }

        /* Player profile */
        .player-profile {
            display: flex;
            align-items: center;
            background: rgba(0, 255, 255, 0.05);
            border-radius: 24px;
            padding: 10px 16px;
            backdrop-filter: blur(6px);
            border: 1px solid rgba(0,255,255,0.2);
            transition: all 0.3s ease-in-out;
        }

        .player-profile img {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            margin-right: 12px;
            border: 2px solid var(--neon);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .player-info {
            flex: 1;
            text-align: left;
        }

        .player-meta {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .player-level {
            color: var(--neon);
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }

        .income {
            font-size: 14px;
            color: #9efaff;
        }

        .progress-bar {
            background: #2e2e4d;
            border-radius: 16px;
            overflow: hidden;
            margin-top: 6px;
            height: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .progress-fill {
            background: linear-gradient(90deg, #49eaff, #4776e6);
            border-radius: 16px;
            width: 0%;
            height: 100%;
            transition: width 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: progressShimmer 2s infinite linear;
        }

        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Shark wrapper */
        .shark-wrapper {
            position: relative;
            width: var(--size);
            aspect-ratio: 1 / 1;
            margin: 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Coin circle with improved effects */
        .coin-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: #0a0a2a;
            box-shadow:
                inset 0 4px 6px rgba(0, 255, 255, 0.1),
                inset 0 -4px 6px rgba(0, 255, 255, 0.05),
                0 6px 10px rgba(0, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.15);
            z-index: 0;
            overflow: hidden;
            animation: pulse 3s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 5px rgba(0, 255, 255, 0.3); }
            50% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.6); }
            100% { box-shadow: 0 0 5px rgba(0, 255, 255, 0.3); }
        }

        .coin-circle::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: linear-gradient(
                to right,
                rgba(0, 255, 255, 0) 0%,
                rgba(0, 255, 255, 0.1) 30%,
                rgba(0, 255, 255, 0.2) 50%,
                rgba(0, 255, 255, 0.1) 70%,
                rgba(0, 255, 255, 0) 100%
            );
            background-repeat: no-repeat;
            background-size: 50% 100%;
            animation: shimmer 3s infinite linear;
            z-index: 1;
        }

        .coin-circle::after {
            content: "";
            position: absolute;
            border-radius: 50%;
            width: var(--inner2);
            height: var(--inner2);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.01);
            box-shadow: inset 0 2px 3px rgba(0, 255, 255, 0.08);
            z-index: 2;
        }

        .coin-circle .inner1 {
            content: "";
            position: absolute;
            border-radius: 50%;
            width: var(--inner1);
            height: var(--inner1);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.02);
            box-shadow: inset 0 2px 4px rgba(0, 255, 255, 0.1);
            z-index: 2;
        }

        /* Shark animation */
        @keyframes shark-float {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.02); }
            100% { transform: translateY(0) scale(1); }
        }

        @keyframes shark-tap-bounce {
            0% { transform: translateY(0) scale(0.95); }
            50% { transform: translateY(-5px) scale(1); }
            100% { transform: translateY(0) scale(0.95); }
        }

        .shark {
            width: 65%;
            z-index: 3;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease;
            filter:
                drop-shadow(0 0 10px rgba(0,255,255,0.4))
                drop-shadow(0 0 30px rgba(0,255,255,0.2));
            animation: shark-float 2s infinite ease-in-out;
        }

        .shark:active {
            transform: scale(0.95);
            animation: shark-tap-bounce 0.3s ease-out;
        }

        /* Tap effects */
        .tap-effect, .tap-plus, .tap-gem, .tap-ore, .tap-energy {
            position: absolute;
            pointer-events: none;
            z-index: 4;
        }

        .tap-effect {
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0,255,255,0.3) 0%, rgba(0,255,255,0) 60%);
            animation: tapBurst 0.6s ease-out;
            width: 120px;
            height: 120px;
            transform: translate(-50%, -50%);
        }

        .tap-plus {
            color: var(--neon);
            font-weight: bold;
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0,255,255,0.5);
            animation: tapPlusAnim 0.8s ease-out;
            transform: translate(-50%, -50%);
        }

        .tap-gem {
            color: var(--gem-color);
            font-weight: bold;
            font-size: 24px;
            text-shadow: 0 0 5px rgba(233, 30, 99, 0.5);
            animation: tapPlusAnim 1s ease-out;
            transform: translate(-50%, -50%);
        }

        .tap-ore {
            color: var(--ore-color);
            font-weight: bold;
            font-size: 24px;
            text-shadow: 0 0 5px rgba(255, 152, 0, 0.5);
            animation: tapPlusAnim 1s ease-out;
            transform: translate(-50%, -50%);
        }

        .tap-energy {
            color: var(--energy-color);
            font-weight: bold;
            font-size: 24px;
            text-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
            animation: tapPlusAnim 1s ease-out;
            transform: translate(-50%, -50%);
        }

        @keyframes tapBurst {
            from { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
            to { opacity: 0; transform: translate(-50%, -50%) scale(2); }
        }

        @keyframes tapPlusAnim {
            from { opacity: 1; transform: translate(-50%, -50%) translateY(0); }
            to { opacity: 0; transform: translate(-50%, -50%) translateY(-40px); }
        }

        /* Shark gallery */
        .shark-gallery {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
        }

        .shark-gallery img {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 1px solid rgba(0,255,255,0.4);
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(4px);
            cursor: pointer;
            object-fit: cover;
            transition: all 0.3s ease;
        }

        .shark-gallery img:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        /* Boost button */
        .boost-btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 999px;
            background: linear-gradient(90deg, #49eaff, #4776e6);
            color: white;
            border: none;
            box-shadow: 0 0 15px rgba(73, 234, 255, 0.4), 0 0 30px rgba(71, 118, 230, 0.3);
            margin-top: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .boost-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: none;
        }

        .boost-btn:hover::before {
            animation: shine 1.5s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            20% { left: 100%; }
            100% { left: 100%; }
        }

        .boost-btn i {
            margin-right: 8px;
        }

        .boost-btn:active {
            transform: scale(0.98);
            box-shadow: 0 0 8px rgba(73, 234, 255, 0.6), 0 0 15px rgba(71, 118, 230, 0.5);
        }

        .boost-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: gray;
            box-shadow: none;
        }

        /* Level up notification */
        .level-up-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 16px;
            border: 2px solid var(--neon);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            z-index: 100;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .level-up-notification.show {
            opacity: 1;
        }

        .level-up-notification h2 {
            color: var(--neon);
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .level-up-notification p {
            margin: 0;
            font-size: 16px;
        }

        /* Achievement notification */
        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid var(--gem-color);
            box-shadow: 0 0 20px rgba(233, 30, 99, 0.3);
            z-index: 100;
            display: flex;
            align-items: center;
            transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 300px;
        }

        .achievement-notification.show {
            transform: translateX(0);
        }

        .achievement-notification i {
            font-size: 24px;
            margin-right: 10px;
            color: var(--gem-color);
        }

        .achievement-notification div {
            flex: 1;
        }

        .achievement-notification h4 {
            margin: 0 0 5px 0;
            color: white;
        }

        .achievement-notification p {
            margin: 0;
            font-size: 14px;
            color: #ccc;
        }

        /* Energy bar */
        .energy-bar-container {
            width: 100%;
            height: 10px;
            background: rgba(46, 46, 77, 0.5);
            border-radius: 10px;
            margin-top: 8px;
            overflow: hidden;
        }

        .energy-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .energy-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: energyShimmer 2s infinite linear;
        }

        @keyframes energyShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Critical hit effect */
        .critical-hit {
            position: absolute;
            font-size: 18px;
            font-weight: bold;
            color: #ff5722;
            text-shadow: 0 0 5px rgba(255, 87, 34, 0.7);
            animation: criticalAnim 1s ease-out;
            z-index: 5;
            pointer-events: none;
        }

        @keyframes criticalAnim {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -150%) scale(1.5); }
        }

        /* Shark evolution glow */
        .evolution-glow {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,215,0,0.5) 0%, rgba(255,215,0,0) 70%);
            animation: evolutionPulse 2s infinite;
            z-index: 2;
}

        @keyframes evolutionPulse {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(0.8); opacity: 0.5; }
        }

        /* Bottom navigation */
        .bottom-nav {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding: 10px 16px;
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(4px);
        }

        .bottom-nav button,
        .bottom-nav a.nav-button {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            opacity: 0.6;
            cursor: pointer;
            transition: opacity 0.3s ease, color 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            position: relative;
        }

        .bottom-nav button.active,
        .bottom-nav a.nav-button.active {
            opacity: 1;
            color: var(--neon);
        }

        .bottom-nav button::after,
        .bottom-nav a.nav-button::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: var(--neon);
            transition: width 0.3s ease;
        }

        .bottom-nav button.active::after,
        .bottom-nav a.nav-button.active::after {
            width: 20px;
        }

        /* Responsive adjustments */
        @media (max-width: 400px) {
            .container {
                padding: 16px;
            }

            .currency span {
                font-size: 12px;
            }

            .player-profile {
                padding: 8px 12px;
            }

            .player-profile img {
                width: 36px;
                height: 36px;
                margin-right: 8px;
            }

            .bottom-nav {
                padding: 8px 12px;
            }

            .bottom-nav button,
            .bottom-nav a.nav-button {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- Floating particles background -->
    <div class="particles" id="particles"></div>

    <!-- Level up notification -->
    <div class="level-up-notification" id="level-up-notification">
        <h2>Уровень повышен!</h2>
        <p>Вы достигли нового уровня!</p>
    </div>

    <!-- Achievement notification -->
    <div class="achievement-notification" id="achievement-notification">
        <i class="fas fa-trophy"></i>
        <div>
            <h4>Новое достижение!</h4>
            <p>Вы получили достижение!</p>
        </div>
    </div>

    <div class="container">
        <div class="currency">
            <span><img src="https://raw.githubusercontent.com/sinobu1/shark-tapper/main/coin.png" alt="Иконка монеты"/> <span id="coin-count" class="coin-count">0</span></span>
            <span><img src="https://raw.githubusercontent.com/sinobu1/shark-tapper/main/dimond.png" alt="Иконка алмаза" class="gem-icon"/> <span id="gem-count" class="gem-count">0</span></span>
            <span><img src="https://raw.githubusercontent.com/sinobu1/shark-tapper/main/ruda.png" alt="Иконка руды" class="ore-icon"/> <span id="ore-count" class="ore-count">0</span></span>
            <span><img src="https://img.icons8.com/ios-filled/50/4CAF50/lightning-bolt.png" alt="Иконка энергии" class="energy-icon"/> <span id="energy-count" class="energy-count">100</span></span>
        </div>

        <div class="player-profile">
            <img id="user-avatar" src="https://img.icons8.com/ios-filled/50/user-male-circle.png" alt="Аватар игрока"/>
            <div class="player-info">
                <div class="player-meta">
                    <span class="player-name" id="user-name">Игрок</span> | <strong class="player-level">Ур. 0</strong>
                </div>
                <div class="income">+0/сек</div>
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <div class="energy-bar-container">
                    <div class="energy-bar" id="energy-bar"></div>
                </div>
            </div>
        </div>

        <div class="shark-wrapper">
            <div class="coin-circle"><div class="inner1"></div></div>
            <img class="shark" src="https://raw.githubusercontent.com/sinobu1/shark-tapper/main/shark.png" onclick="tapShark(event)" alt="Акула">
        </div>
        <div class="shark-gallery">
            <img src="https://raw.githubusercontent.com/sinobu1/shark-tapper/main/coin.png" alt="Иконка монеты"/>
            <img src="https://raw.githubusercontent.com/sinobu1/shark-tapper/main/coin.png" alt="Иконка монеты"/>
            <img src="https://raw.githubusercontent.com/sinobu1/shark-tapper/main/coin.png" alt="Иконка монеты"/>
        </div>
        <button class="boost-btn" id="boost-button" onclick="activateBoost()">
            <i class="fas fa-rocket"></i> Буст
        </button>

        <div class="bottom-nav">
            <button class="active"><i class="fas fa-fish"></i></button>
            <button onclick="window.location.href='shop.html'"><i class="fas fa-store"></i></button>
            <button onclick="window.location.href='profile.html'"><i class="fas fa-user"></i></button>
            <a href="map.html" class="nav-button"><i class="fas fa-map"></i></a>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB4X2wWQKQ7Q9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q",
            authDomain: "tralalero-fec07.firebaseapp.com",
            databaseURL: "https://tralalero-fec07-default-rtdb.firebaseio.com",
            projectId: "tralalero-fec07",
            storageBucket: "tralalero-fec07.appspot.com",
            messagingSenderId: "8019182445",
            appId: "1:8019182445:web:9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Telegram Web App initialization
        const tg = window.Telegram.WebApp;
        tg.expand(); // Expand the Web App to full screen
        
        // Game state
        let coinCount = 0;
        let gemCount = 0;
        let oreCount = 0;
        let energy = 100;
        let maxEnergy = 100;
        let passiveIncome = 0;
        let playerLevel = 0;
        let playerProgress = 0;
        let progressToNextLevel = 100;
        let baseTapValue = 1;
        let currentTapValue = 1;
        let boostActive = false;
        let totalCoins = 0;
        let totalGems = 0;
        let totalOre = 0;
        let totalTaps = 0;
        let incomeMultiplier = 1;
        let criticalChance = 0.05; // 5% base critical chance
        let criticalMultiplier = 2;
        let oreChance = 0.03; // 3% base ore chance
        let energyRegenRate = 1; // Energy regen per second
        let energyCostPerTap = 1;
        let userId = tg.initDataUnsafe.user?.id || 'default_user';

        // Helper data
        const helpers = {
            dolphin: { cost: 500, income: 20, owned: 0 },
            orca: { cost: 1500, income: 50, owned: 0 },
            whale: { cost: 5000, income: 100, owned: 0 }
        };

        // Skins data
        const skins = {
            golden: { cost: 1000, multiplier: 1.1, owned: false },
            crystal: { cost: 5000, multiplier: 1.25, owned: false },
            legendary: { cost: 15000, multiplier: 1.5, owned: false }
        };

        // Upgrades data
        const upgrades = {
            powerTap: { cost: 2000, effect: 1, owned: false },
            criticalChance: { cost: 5000, effect: 0.1, owned: false },
            oreChance: { cost: 3000, effect: 0.05, owned: false }
        };

        // Achievements
        const achievements = {
            firstTap: { name: "Первые шаги", description: "Сделайте 100 тапов", threshold: 100, unlocked: false },
            richTapper: { name: "Богатый тапер", description: "Заработайте 10,000 монет", threshold: 10000, unlocked: false },
            sharkMaster: { name: "Мастер акул", description: "Достигните 10 уровня", threshold: 10, unlocked: false },
            criticalHit: { name: "Критический удар", description: "Сделайте 10 критических ударов", threshold: 10, unlocked: false, progress: 0 },
            energyMaster: { name: "Энергичный", description: "Используйте 1000 энергии", threshold: 1000, unlocked: false, progress: 0 }
        };

        // DOM elements
        const coinCountElement = document.getElementById('coin-count');
        const gemCountElement = document.getElementById('gem-count');
        const oreCountElement = document.getElementById('ore-count');
        const energyCountElement = document.getElementById('energy-count');
        const energyBarElement = document.getElementById('energy-bar');
        const playerLevelElement = document.querySelector('.player-level');
        const progressFillElement = document.querySelector('.progress-fill');
        const incomeElement = document.querySelector('.income');
        const boostButton = document.getElementById('boost-button');
        const levelUpNotification = document.getElementById('level-up-notification');
        const achievementNotification = document.getElementById('achievement-notification');
        const userNameElement = document.getElementById('user-name');
        const userAvatarElement = document.getElementById('user-avatar');

        // Format numbers with k, m, b suffixes
        function formatNumber(num) {
            if (num < 10000) {
                return num;
            } else if (num < 1000000) {
                return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
            } else if (num < 1000000000) {
                return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'm';
            } else {
                return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'b';
            }
        }

        // Create floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = Math.floor(window.innerWidth / 10);

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');

                // Random size between 1px and 3px
                const size = Math.random() * 2 + 1;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;

                // Random position
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;

                // Random opacity
                particle.style.opacity = Math.random() * 0.5 + 0.1;

                // Random animation duration and delay
                const duration = Math.random() * 20 + 10;
                const delay = Math.random() * 5;
                particle.style.animation = `float ${duration}s linear ${delay}s infinite`;

                // Add to container
                particlesContainer.appendChild(particle);
            }

            // Add floating animation
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes float {
                    0% { transform: translateY(0) translateX(0); }
                    50% { transform: translateY(-100px) translateX(20px); }
                    100% { transform: translateY(-200px) translateX(0); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // Show level up notification
        function showLevelUp() {
            levelUpNotification.classList.add('show');
            
            // Add evolution glow effect
            const sharkWrapper = document.querySelector('.shark-wrapper');
            const glow = document.createElement('div');
            glow.className = 'evolution-glow';
            sharkWrapper.appendChild(glow);
            
            setTimeout(() => {
                levelUpNotification.classList.remove('show');
                glow.remove();
            }, 2000);
        }

        // Show achievement notification
        function showAchievement(achievement) {
            const notification = achievementNotification;
            notification.querySelector('h4').textContent = achievement.name;
            notification.querySelector('p').textContent = achievement.description;

            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Check achievements
        function checkAchievements() {
            // First tap achievement
            if (totalTaps >= achievements.firstTap.threshold && !achievements.firstTap.unlocked) {
                achievements.firstTap.unlocked = true;
                showAchievement(achievements.firstTap);
                gemCount += 5; // Reward for achievement
                gemCountElement.textContent = gemCount;
                saveGame();
            }

            // Rich tapper achievement
            if (totalCoins >= achievements.richTapper.threshold && !achievements.richTapper.unlocked) {
                achievements.richTapper.unlocked = true;
                showAchievement(achievements.richTapper);
                gemCount += 10; // Reward for achievement
                gemCountElement.textContent = gemCount;
                saveGame();
            }

            // Shark master achievement
            if (playerLevel >= achievements.sharkMaster.threshold && !achievements.sharkMaster.unlocked) {
                achievements.sharkMaster.unlocked = true;
                showAchievement(achievements.sharkMaster);
                gemCount += 20; // Reward for achievement
                gemCountElement.textContent = gemCount;
                saveGame();
            }

            // Critical hit achievement
            if (achievements.criticalHit.progress >= achievements.criticalHit.threshold && !achievements.criticalHit.unlocked) {
                achievements.criticalHit.unlocked = true;
                showAchievement(achievements.criticalHit);
                gemCount += 15; // Reward for achievement
                gemCountElement.textContent = gemCount;
                saveGame();
            }

            // Energy master achievement
            if (achievements.energyMaster.progress >= achievements.energyMaster.threshold && !achievements.energyMaster.unlocked) {
                achievements.energyMaster.unlocked = true;
                showAchievement(achievements.energyMaster);
                gemCount += 25; // Reward for achievement
                gemCountElement.textContent = gemCount;
                saveGame();
            }
        }

        // Tap shark function
        function tapShark(e) {
            // Check if player has enough energy
            if (energy < energyCostPerTap) {
                alert("Недостаточно энергии! Подождите пока она восстановится.");
                return;
            }

            // Deduct energy
            energy -= energyCostPerTap;
            energyCountElement.textContent = energy;
            energyBarElement.style.width = `${(energy / maxEnergy) * 100}%`;
            
            // Track energy usage for achievement
            achievements.energyMaster.progress += energyCostPerTap;
            checkAchievements();

            // Calculate tap value (with chance for critical hit)
            let isCritical = false;
            const random = Math.random();
            
            if (random < criticalChance) {
                currentTapValue = Math.floor(baseTapValue * criticalMultiplier);
                isCritical = true;
                achievements.criticalHit.progress++;
                checkAchievements();
            } else {
                currentTapValue = baseTapValue;
            }

            // Add coins
            coinCount += currentTapValue;
            totalCoins += currentTapValue;
            coinCountElement.textContent = formatNumber(coinCount);

            // Increment tap counter
            totalTaps++;
            
            // Random drops
            const dropRandom = Math.random();

            // Gem drop chance (1%)
            if (dropRandom < 0.01) {
                gemCount++;
                totalGems++;
                gemCountElement.textContent = gemCount;
                showTapEffect(e, 'gem');
            } 
            // Ore drop chance (base 3% + upgrades)
            else if (dropRandom < oreChance) {
                oreCount++;
                totalOre++;
                oreCountElement.textContent = oreCount;
                showTapEffect(e, 'ore');
            } 
            // Normal coin tap
            else {
                showTapEffect(e, 'coin', currentTapValue);
            }

            // Show critical hit effect if critical
            if (isCritical) {
                showCriticalEffect(e);
            }

            // Update player progress
            playerProgress++;
            const progressPercentage = (playerProgress / progressToNextLevel) * 100;
            progressFillElement.style.width = Math.min(progressPercentage, 100) + '%';

            // Check for level up
            if (playerProgress >= progressToNextLevel) {
                playerLevel++;
                playerLevelElement.textContent = `Ур. ${playerLevel}`;
                playerProgress = 0;
                progressToNextLevel = Math.floor(progressToNextLevel * 1.5);
                if (progressToNextLevel < 100) progressToNextLevel = 100;
                progressFillElement.style.width = '0%';

                // Show level up notification
                showLevelUp();

                // Increase tap value every 5 levels
                if (playerLevel % 5 === 0) {
                    baseTapValue++;
                }
            }

            // Check achievements
            checkAchievements();

            // Save game state
            saveGame();
        }

        // Show tap effect
        function showTapEffect(e, type, value = 1) {
            const shark = e.target;
            const wrapper = shark.closest('.shark-wrapper');
            const wrapperRect = wrapper.getBoundingClientRect();

            // Create effect
            const effect = document.createElement('div');
            effect.className = 'tap-effect';
            effect.style.left = (e.clientX - wrapperRect.left) + 'px';
            effect.style.top = (e.clientY - wrapperRect.top) + 'px';
            wrapper.appendChild(effect);

            // Create text
            const text = document.createElement('div');

            if (type === 'gem') {
                text.className = 'tap-gem';
                text.innerText = '+1 Гем';
            } else if (type === 'ore') {
                text.className = 'tap-ore';
                text.innerText = '+1 Руда';
            } else if (type === 'energy') {
                text.className = 'tap-energy';
                text.innerText = `-${value} Энергия`;
            } else {
                text.className = 'tap-plus';
                text.innerText = `+${value}`;
            }

            text.style.left = (e.clientX - wrapperRect.left) + 'px';
            text.style.top = (e.clientY - wrapperRect.top) + 'px';
            wrapper.appendChild(text);

            // Remove after animation
            setTimeout(() => {
                effect.remove();
                text.remove();
            }, type === 'gem' || type === 'ore' ? 1000 : 800);
        }

        // Show critical hit effect
        function showCriticalEffect(e) {
            const shark = e.target;
            const wrapper = shark.closest('.shark-wrapper');
            const wrapperRect = wrapper.getBoundingClientRect();

            const critText = document.createElement('div');
            critText.className = 'critical-hit';
            critText.innerText = 'КРИТ!';
            critText.style.left = (e.clientX - wrapperRect.left) + 'px';
            critText.style.top = (e.clientY - wrapperRect.top) + 'px';
            wrapper.appendChild(critText);

            setTimeout(() => {
                critText.remove();
            }, 1000);
        }

        // Activate boost
        function activateBoost() {
            if (boostActive) return;

            // Check if player has enough gems
            if (gemCount < 1) {
                alert("Недостаточно гемов для буста!");
                return;
            }

            // Deduct gem
            gemCount--;
            gemCountElement.textContent = gemCount;

            // Activate boost
            boostActive = true;
            baseTapValue *= 2;
            boostButton.disabled = true;
            boostButton.innerHTML = '<i class="fas fa-rocket"></i> Буст Активен!';

            // Show boost effect
            const originalShark = document.querySelector('.shark');
            const boostEffect = document.createElement('div');
            boostEffect.style.position = 'absolute';
            boostEffect.style.width = '100%';
            boostEffect.style.height = '100%';
            boostEffect.style.background = 'radial-gradient(circle, rgba(0,255,255,0.3) 0%, rgba(0,255,255,0) 70%)';
            boostEffect.style.borderRadius = '50%';
            boostEffect.style.animation = 'pulse 0.5s infinite alternate';
            originalShark.parentElement.appendChild(boostEffect);

            // End boost after 10 seconds
            setTimeout(() => {
                boostActive = false;
                baseTapValue = Math.max(1, Math.floor(baseTapValue / 2));
                boostButton.disabled = false;
                boostButton.innerHTML = '<i class="fas fa-rocket"></i> Буст';
                boostEffect.remove();
                saveGame();
            }, 10000);
        }

        // Passive income interval
        setInterval(() => {
            if (passiveIncome > 0) {
                coinCount += passiveIncome;
                totalCoins += passiveIncome;
                coinCountElement.textContent = formatNumber(coinCount);
                saveGame();
            }
        }, 1000);

        // Energy regeneration
        setInterval(() => {
            if (energy < maxEnergy) {
                energy = Math.min(maxEnergy, energy + energyRegenRate);
                energyCountElement.textContent = energy;
                energyBarElement.style.width = `${(energy / maxEnergy) * 100}%`;
                saveGame();
            }
        }, 1000);

        // Save game state to Firebase
        function saveGame() {
            const gameState = {
                coinCount,
                gemCount,
                oreCount,
                energy,
                passiveIncome,
                playerLevel,
                playerProgress,
                progressToNextLevel,
                baseTapValue,
                totalCoins,
                totalGems,
                totalOre,
                totalTaps,
                incomeMultiplier,
                criticalChance,
                oreChance,
                helpers,
                skins,
                upgrades,
                achievements
            };
            
            // Save to Firebase
            database.ref('users/' + userId).set(gameState)
                .then(() => console.log('Game saved successfully'))
                .catch(error => console.error('Error saving game:', error));
        }

        // Load game state from Firebase
        function loadGame() {
            database.ref('users/' + userId).once('value')
                .then((snapshot) => {
                    const gameState = snapshot.val();
                    
                    if (gameState) {
                        // Restore all game state variables
                        coinCount = gameState.coinCount || 0;
                        gemCount = gameState.gemCount || 0;
                        oreCount = gameState.oreCount || 0;
                        energy = gameState.energy || 100;
                        passiveIncome = gameState.passiveIncome || 0;
                        playerLevel = gameState.playerLevel || 0;
                        playerProgress = gameState.playerProgress || 0;
                        progressToNextLevel = gameState.progressToNextLevel || 100;
                        baseTapValue = gameState.baseTapValue || 1;
                        totalCoins = gameState.totalCoins || 0;
                        totalGems = gameState.totalGems || 0;
                        totalOre = gameState.totalOre || 0;
                        totalTaps = gameState.totalTaps || 0;
                        incomeMultiplier = gameState.incomeMultiplier || 1;
                        criticalChance = gameState.criticalChance || 0.05;
                        oreChance = gameState.oreChance || 0.03;
                        
                        // Restore complex objects
                        if (gameState.helpers) {
                            for (const key in gameState.helpers) {
                                if (helpers[key]) {
                                    helpers[key].owned = gameState.helpers[key].owned || 0;
                                }
                            }
                        }
                        
                        if (gameState.skins) {
                            for (const key in gameState.skins) {
                                if (skins[key]) {
                                    skins[key].owned = gameState.skins[key].owned || false;
                                    if (skins[key].owned) {
                                        incomeMultiplier = skins[key].multiplier;
                                    }
                                }
                            }
                        }
                        
                        if (gameState.upgrades) {
                            for (const key in gameState.upgrades) {
                                if (upgrades[key]) {
                                    upgrades[key].owned = gameState.upgrades[key].owned || false;
                                    if (upgrades[key].owned) {
                                        if (key === 'powerTap') baseTapValue += upgrades[key].effect;
                                        if (key === 'criticalChance') criticalChance += upgrades[key].effect;
                                        if (key === 'oreChance') oreChance += upgrades[key].effect;
                                    }
                                }
                            }
                        }
                        
                        if (gameState.achievements) {
                            for (const key in gameState.achievements) {
                                if (achievements[key]) {
                                    achievements[key].unlocked = gameState.achievements[key].unlocked || false;
                                    achievements[key].progress = gameState.achievements[key].progress || 0;
                                }
                            }
                        }

                        // Update UI
                        coinCountElement.textContent = formatNumber(coinCount);
                        gemCountElement.textContent = gemCount;
                        oreCountElement.textContent = oreCount;
                        energyCountElement.textContent = energy;
                        energyBarElement.style.width = `${(energy / maxEnergy) * 100}%`;
                        playerLevelElement.textContent = `Ур. ${playerLevel}`;
                        
                        const progressPercentage = (playerProgress / progressToNextLevel) * 100;
                        progressFillElement.style.width = `${progressPercentage}%`;
                        
                        incomeElement.textContent = `+${passiveIncome}/сек`;
                    }
                })
                .catch(error => console.error('Error loading game:', error));
        }

        // Initialize Telegram Web App user data
        function initTelegramUser() {
            if (tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                userNameElement.textContent = user.first_name || 'Игрок';
                
                if (user.photo_url) {
                    userAvatarElement.src = user.photo_url;
                }
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            initTelegramUser();
            loadGame();

            coinCountElement.textContent = formatNumber(coinCount);
            gemCountElement.textContent = gemCount;
            oreCountElement.textContent = oreCount;
            energyCountElement.textContent = energy;
            energyBarElement.style.width = '100%';

            playerLevelElement.textContent = `Ур. ${playerLevel}`;
            progressFillElement.style.width = '0%';
            incomeElement.textContent = `+${passiveIncome}/сек`;
        });

        // Auto-save every 30 seconds
        setInterval(saveGame, 30000);

        // Save game when page is about to unload
        window.addEventListener('beforeunload', () => {
            saveGame();
        });
    </script>
</body>
</html>