<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>Shark Tapper</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Luckiest+Guy&family=Press+Start+2P&family=Rubik+Mono+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
    :root {
        --primary: #2f80ed;
        --accent: #56ccf2;
        --bg: #f2f5f9;
        --card-bg: #ffffff;
        --text: #0d1b2a;
        --subtext: #6c7787;
        --border: #e0e6ed;
        --coin-color: #f8d030; /* Цвет монеток */
    }
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        -webkit-user-select: none;
        user-select: none;
    }
    html, body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        touch-action: manipulation;
    }
    body {
        font-family: 'Bungee', cursive, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; /* Добавлены системные шрифты для iOS */
        background:
            url('fon.png') center/cover no-repeat, /* Ваша картинка сверху */
            linear-gradient(180deg, #dbeafe 0%, #f0f4f8 100%); /* Старый градиент снизу */
        color: var(--text);
        -webkit-font-smoothing: antialiased;
        position: fixed;
        /* Добавьте здесь CSS-фильтры, например:
        filter: brightness(90%) contrast(110%) saturate(130%) sepia(20%);
        */
    }
    #app-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    header {
        background: none;
        color: var(--primary);
        padding: 1rem;
        text-align: center;
        font-size: 2.5rem; /* Увеличим размер шрифта заголовка */
        font-family: 'Luckiest Guy', cursive; /* Используем новый шрифт */
        text-shadow: -2px -2px 0 #fff, 2px -2px 0 #fff, -2px 2px 0 #fff, 2px 2px 0 #fff;
        flex-shrink: 0;
    }
    .main-content {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    .tab-content {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 60px;
    }
    .token-counter {
        margin: 0 auto;
        font-size: 0.9rem; /* Немного увеличим размер шрифта */
        color: var(--primary);
        background: var(--card-bg);
        padding: 0.6rem 1.2rem; /* Увеличим отступы */
        border-radius: 14px; /* Сделаем углы более круглыми */
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1); /* Более мягкая тень */
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        font-family: 'Luckiest Guy', cursive; /* Шрифт Luckiest Guy для контейнера */
        line-height: 1.2;
    }
    .token-counter img {
        height: 18px; /* Уменьшим размер иконки монеты в счетчике */
    }
    .token-counter #profileTokens {
        font-family: 'Press Start 2P', cursive; /* Пиксельный шрифт для числа */
    }
    .shark-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1.5rem; /* Увеличим отступ */
        flex: 1;
    }
    .shark-tap-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.7rem; /* Увеличим отступ */
    }
    .shark-image {
        width: 150px; /* Немного увеличим размер акулы */
        height: 150px;
        border-radius: 50%;
        border: 4px solid var(--accent);
        background: var(--card-bg);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); /* Более выраженная тень */
        object-fit: cover;
        cursor: pointer;
        transition: transform 0.1s ease;
        will-change: transform; /* Добавлено для производительности анимации */
    }
    .shark-gallery {
        margin: 1.2rem 0; /* Увеличим отступ */
        padding: 0.6rem; /* Увеличим отступ */
        display: flex;
        justify-content: center;
        gap: 0.8rem; /* Увеличим отступ */
        overflow-x: auto;
        width: 100%;
        scrollbar-width: none;
    }
    .shark-gallery::-webkit-scrollbar {
        display: none;
    }
    .shark-gallery img {
        width: 52px; /* Немного увеличим размер иконок скинов */
        height: 52px;
        border-radius: 50%;
        border: 2px solid var(--primary);
        background: white;
        object-fit: cover;
        box-shadow: 0 3px 8px rgba(0,0,0,0.1); /* Мягкая тень */
        flex-shrink: 0;
        transition: transform 0.2s ease;
        will-change: transform; /* Добавлено для производительности анимации */
        cursor: pointer; /* Добавим курсор, чтобы показать, что они кликабельны */
    }
    .shark-gallery img:hover {
        transform: scale(1.1);
    }
    .profile-card {
        background: var(--card-bg);
        border-radius: 1.8rem; /* Более круглые углы */
        padding: 1.2rem; /* Увеличим отступ */
        margin: 1rem;
        border: 1px solid var(--border);
        box-shadow: 0 10px 20px rgba(0,0,0,0.06); /* Более мягкая тень */
        display: flex;
        gap: 1rem; /* Увеличим отступ */
        align-items: center;
    }
    .profile-card img {
        width: 60px; /* Немного увеличим размер аватара */
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--accent);
        flex-shrink: 0;
    }
    .profile-info {
        display: flex;
        flex-direction: column;
        width: 100%;
        min-width: 0;
    }
    .profile-info .name {
        font-weight: 600;
        font-size: 1rem; /* Увеличим размер шрифта имени */
        font-family: 'Press Start 2P', cursive;
        line-height: 1.3;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .profile-info .sub {
        font-size: 0.9rem; /* Увеличим размер шрифта подписи */
        color: var(--subtext);
        font-family: 'Bungee', cursive;
    }
    .xp-bar {
        width: 100%;
        height: 8px; /* Увеличим высоту полоски опыта */
        background: var(--border);
        border-radius: 999px;
        overflow: hidden;
        margin-top: 0.6rem; /* Увеличим отступ */
    }
    .xp-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(to right, var(--primary), var(--accent));
        transition: width 0.3s ease;
        border-radius: inherit; /* Наследуем радиус от родителя */
    }
    nav {
        width: 100%;
        display: flex;
        background: var(--card-bg);
        border-top: 1px solid var(--border);
        padding: 0.7rem 0; /* Увеличим отступ */
        box-shadow: 0 -6px 16px rgba(0,0,0,0.06); /* Более мягкая тень */
        backdrop-filter: blur(12px);
        z-index: 100;
        flex-shrink: 0;
    }
    nav button {
        flex: 1;
        background: none;
        border: none;
        font-size: 0.75rem; /* Увеличим размер шрифта кнопок */
        color: var(--subtext);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.3rem; /* Увеличим отступ */
        font-family: 'Bungee', cursive;
        transition: transform 0.1s ease-in-out; /* Добавим плавную анимацию при нажатии */
    }
    nav button:active {
        transform: scale(0.95);
    }
    nav button i {
        font-size: 1.2rem; /* Увеличим размер иконок */
    }
    nav button.active {
        color: var(--primary);
        font-weight: 700;
    }
    nav button#buyTapUpgradeNav {
        flex-direction: row; /* Размещаем иконку и текст в ряд */
        justify-content: center; /* Центрируем содержимое */
        align-items: center;
        gap: 0.5rem; /* Расстояние между иконкой и текстом */
        color: var(--accent); /* Цвет текста улучшения */
        font-weight: bold; /* Делаем текст жирным */
    }
    nav button#buyTapUpgradeNav span {
        display: flex; /* Чтобы span мог содержать flex элементы */
        align-items: center;
        gap: 0.3rem;
    }
    nav button#buyTapUpgradeNav i {
        font-size: 1rem; /* Уменьшаем размер иконки улучшения */
    }
    nav button#buyTapUpgradeNav.disabled {
        color: var(--subtext); /* Цвет, когда недостаточно монет */
        cursor: not-allowed;
    }
    .tap-effect {
        position: absolute;
        width: 50px; /* Немного увеличим размер эффекта */
        height: 50px;
        background: radial-gradient(circle, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0) 70%); /* Сделаем эффект менее интенсивным */
        border-radius: 50%;
        pointer-events: none;
        transform: translate(-50%, -50%);
        animation: tapAnimation 0.6s forwards;
        z-index: 10;
    }
    @keyframes tapAnimation {
        0% { transform: translate(-50%, -50%) scale(0.6); opacity: 0.8; }
        100% { transform: translate(-50%, -50%) scale(2.2); opacity: 0; }
    }
    .coin-popup {
        position: absolute;
        font-family: 'Press Start 2P', cursive;
        color: var(--coin-color); /* Используем цвет монеток */
        text-shadow: 1px 1px 0 #b88b00, -1px -1px 0 #b88b00;
        font-size: 1rem; /* Увеличим размер шрифта */
        animation: coinPopup 1s forwards;
        pointer-events: none;
        z-index: 20;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    .coin-popup img {
        height: 20px; /* Размер иконки монеты во всплывающем сообщении */
    }
    @keyframes coinPopup {
        0% { transform: translateY(0); opacity: 1; }
        100% { transform: translateY(-60px); opacity: 0; } /* Увеличим расстояние подъема */
    }
    .tab-page {
        display: none;
        height: 100%;
        flex-direction: column;
    }
    .tab-page.active {
        display: flex;
    }
    .leaderboard-item {
        margin-bottom: 0.6rem; /* Увеличим отступ */
        display: flex;
        align-items: center;
        gap: 0.7rem; /* Увеличим отступ */
        padding: 0.7rem; /* Увеличим отступ */
        border-radius: 14px; /* Более круглые углы */
        background: transparent;
        transition: background 0.2s ease;
    }
    .leaderboard-item.current-user {
        background: rgba(47, 128, 237, 0.15); /* Сделаем выделение текущего пользователя чуть более заметным */
    }

    /* --- Стили для кнопки улучшения под профилем --- */
    .upgrade-button-container {
        display: flex;
        justify-content: center; /* To center the button */
        margin-top: 1rem; /* Add some space above the button */
        padding: 0 1rem; /* Add some padding on the sides */
    }

    .upgrade-button {
        background: linear-gradient(135deg, var(--accent), #81ecec); /* Добавляем градиент */
        color: white;
        font-family: 'Rubik Mono One', sans-serif; /* Используем шрифт Rubik Mono One */
        font-weight: bold;
        border: none;
        border-radius: 24px; /* Увеличиваем радиус скругления */
        padding: 0.8rem 1.5rem;
        font-size: 0.9rem;
        cursor: pointer;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2); /* Усиливаем тень под градиент */
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        -webkit-tap-highlight-color: transparent; /* Remove highlight on tap */
        -webkit-user-select: none;
        user-select: none;
    }

    .upgrade-button:hover {
        background: linear-gradient(135deg, #81ecec, var(--accent)); /* Инвертируем градиент на hover */
    }

    .upgrade-button:active {
        transform: scale(0.98);
    }

    .upgrade-button i {
        font-size: 1rem;
    }

    .upgrade-button img {
        height: 16px;
        vertical-align: middle;
    }

    .upgrade-button.disabled {
        background-color: var(--subtext);
        color: #ddd;
        cursor: not-allowed;
    }

    .upgrade-button.disabled:hover {
        background-color: var(--subtext);
    }

    .profile-card img.level-animated-gradient-frame {
        border: 3px solid transparent;
        border-radius: 50%;
        background: linear-gradient(to right, var(--primary), var(--accent));
        background-clip: border-box;
        animation: gradientShift 5s infinite linear;
    }

    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* Стили для модальных окон */
    .modal {
        display: none; /* Скрыто по умолчанию */
        position: fixed; /* Остается на месте */
        z-index: 1; /* Сидит поверх всего */
        left: 0;
        top: 0;
        width: 100%; /* Полная ширина */
        height: 100%; /* Полная высота */
        overflow: auto; /* Включить прокрутку, если контент слишком большой */
        background-color: rgba(0,0,0,0.4); /* Черный с прозрачностью */
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* 15% сверху и по центру */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Можно настроить ширину */
        border-radius: 1rem;
        position: relative;
    }

    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    /* Стили для раздела помощников внутри модального окна */
    .helpers-container {
        padding: 0.8rem;
    }

    .helper-item {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 0.8rem;
        padding: 0.6rem;
        margin-bottom: 0.6rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column; /* Элементы внутри располагаем вертикально */
        gap: 0.4rem; /* Уменьшим зазор между основными блоками */
    }

    .helper-top-info {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        margin-bottom: 0.4rem; /* Добавим немного отступа до описания */
    }

    .helper-emoji-frame {
        width: 30px;
        height: 30px;
        border: 1px solid var(--border);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1rem;
        flex-shrink: 0; /* Чтобы не сжимался */
    }

    .helper-name-description {
        flex-grow: 1;
        min-width: 0;
        margin-left: 0.4rem; /* Уменьшим отступ слева */
    }

    .helper-name {
        font-weight: bold;
        font-family: 'Rubik Mono One', sans-serif;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.65rem; /* Еще немного уменьшим шрифт, если нужно будет */
        margin-bottom: 0.2rem; /* Небольшой отступ между именем и описанием */
    }

    .helper-description {
        color: var(--subtext);
        font-size: 0.6rem;
        font-family: sans-serif;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .helper-bottom-actions {
        display: flex;
        align-items: center;
        justify-content: space-between; /* Размещаем кнопку слева, доход справа */
        gap: 0.5rem; /* Небольшой зазор между элементами */
    }

    .buy-button {
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 0.4rem;
        padding: 0.15rem 0.3rem; /* Уменьшим отступы кнопки */
        cursor: pointer;
        font-size: 0.45rem; /* Уменьшим шрифт кнопки */
        transition: background-color 0.2s ease;
        white-space: nowrap;
    }

    .buy-button:hover {
        background-color: #42b8d4;
    }

    .buy-button.disabled {
        background-color: var(--subtext);
        cursor: not-allowed;
    }

    .helper-income {
        font-size: 0.6rem;
        display: flex;
        gap: 0.1rem; /* Уменьшим основной зазор */
        align-items: center;
        font-family: 'Press Start 2P', cursive;
        flex-direction: column; /* Размещаем доход и "Куплено" вертикально */
        align-items: flex-end; /* Выравниваем по правому краю */
    }

    .helper-income span {
        display: flex; /* Чтобы разместить текст и иконку в одну строку */
        align-items: center;
        gap: 0.1rem;
    }

    .helper-income img {
        height: 9px; /* Уменьшим размер иконки */
        margin-right: 0.1rem; /* Небольшой отступ справа от иконки */
    }

    .income-text {
        font-family: 'Press Start 2P', cursive;
        font-size: 0.6rem; /* Используем тот же шрифт, что и для дохода */
        white-space: nowrap;
        display: flex;
        align-items: center;
    }

    .owned-text {
        font-family: 'Press Start 2P', cursive;
        font-size: 0.45rem; /* Уменьшим шрифт */
        white-space: nowrap;
        margin-top: 0.1rem; /* Уменьшим отступ снизу */
        text-align: right; /* Выравниваем по правому краю */
    }

    .helpers-list {
        margin-top: 0.8rem;
    }

    .helpers-list h3 {
        font-family: 'Rubik Mono One', sans-serif;
        margin-bottom: 0.4rem;
        text-align: center;
        font-size: 0.9rem;
    }
</style>
</head>
<body>
    <div id="app-container">
        <header>SHARK TAPPER</header>

        <div class="main-content">
            <div class="tab-content">
                <div id="home" class="tab-page active">
                    <div class="shark-wrapper">
                        <div class="shark-tap-container">
                            <div class="token-counter" id="tokenCounter">
                                <img src="https://sinobu1.github.io/shark-tapper/coin_icon_small.png" alt="Coin Icon" class="coin-icon" />
                                <span id="profileTokens">0</span>
                            </div>
                            <img src="https://sinobu1.github.io/shark-tapper/shark.png" alt="Tap Shark" class="shark-image" id="tapImage" />
                        </div>
                        <div class="shark-gallery">
                            <img src="ww.png" alt="Shark 1" data-skin="default" />
                            <img src="https://sinobu1.github.io/shark-tapper/shark_skin1.png" alt="Gold Shark" data-skin="skin3" />
                            <img src="https://sinobu1.github.io/shark-tapper/shark_skin2.png" alt="Leopard Shark" data-skin="skin2" />
                        </div>
                    </div>
                    <div class="profile-card">
                        <img src="https://placehold.co/64x64" alt="Avatar" id="profileAvatar">
                        <div class="profile-info">
                            <span class="name" id="profileName">Player</span>
                            <span class="sub" id="profileLevel">Level: 0 | Coins: 0</span>
                            <div class="xp-bar">
                                <div class="xp-fill" id="xpBar"></div>
                            </div>
                        </div>
                    </div>
                    <div class="upgrade-button-container">
                        <button id="buyTapUpgradeNav" class="upgrade-button">
                            <i class="fa-solid fa-rocket"></i><span>Boost +<span id="tapMultiplierDisplay">1</span> - <span id="tapUpgradeCostNav">50</span> <img src="https://sinobu1.github.io/shark-tapper/coin_icon_small.png" alt="Coin" style="height: 14px; vertical-align: middle;"></span>
                        </button>
                    </div>
                </div>

                <div id="quests" class="tab-page">
                    <div style="padding: 1rem; text-align: center; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem;">
                        <h2 style="font-family: 'Rubik Mono One', sans-serif; margin-bottom: 1rem;">📝 Quests</h2>
                        <button class="upgrade-button" id="inviteFriendQuest">
                            <i class="fa-solid fa-user-plus"></i> Приведи друга за 100 монет
                        </button>
                        <p style="color: var(--subtext);">Больше квестов появится позже!</p>
                        <div id="referralLinkContainer" style="margin-top: 1rem;">
                            </div>
                    </div>
                </div>

                <div id="shop" class="tab-page">
                    <div style="padding: 1rem;">
                        <h2 style="font-family: 'Rubik Mono One', sans-serif; margin-bottom: 1rem; text-align: center;">🛍 Shop</h2>
                        <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                            <button class="upgrade-button" id="openHelpersModal">
                                <i class="fa-solid fa-fish"></i> Наши помощники
                            </button>
                            <button class="upgrade-button" id="openSkinsModal">
                                <i class="fa-solid fa-shirt"></i> Скины
                            </button>
                            </div>
                    </div>
                </div>

                <div id="leaderboard" class="tab-page">
                    <div style="padding: 1rem;">
                        <h2 style="text-align:center; font-family: 'Rubik Mono One', sans-serif; margin-bottom: 1rem;">TOP PLAYERS</h2>
                        <ul id="leaderboardList" style="list-style: none; padding: 0; margin: 0;">
                            <li style="text-align:center; color: var(--subtext);">Loading...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <nav>
            <button class="active" data-tab="home">
                <i class="fa-solid fa-gamepad"></i><span>Games</span>
            </button>
            <button data-tab="quests">
                <i class="fa-solid fa-list-check"></i><span>Quests</span>
            </button>
            <button data-tab="shop">
                <i class="fa-solid fa-store"></i><span>Shop</span>
            </button>
            <button data-tab="leaderboard">
                <i class="fa-solid fa-ranking-star"></i><span>Top</span>
            </button>
        </nav>

        <div id="helpersModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-button" id="closeHelpersModal">&times;</span>
                <div class="helpers-container">
                    <div class="helpers-list">
                        <h3>Наши помощники:</h3>
                        <ul id="helpersListUI" style="list-style: none; padding: 0; margin-top: 0.5rem;">
                            </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="skinsModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-button" id="closeSkinsModal">&times;</span>
                <div class="shark-gallery" style="margin-top: 1rem; justify-content: center;">
                    <img src="https://sinobu1.github.io/shark-tapper/shark.png" alt="Shark 1" data-skin="default" />
                    <img src="https://sinobu1.github.io/shark-tapper/shark_skin1.png" alt="Gold Shark" data-skin="skin3" />
                    <img src="https://sinobu1.github.io/shark-tapper/shark_skin2.png" alt="Leopard Shark" data-skin="skin2" />
                </div>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        function feedback() {
            // 1. Вибрация (если поддерживается)
            if ('vibrate' in navigator) {
                navigator.vibrate([30]);
            }

            // 2. Звук тапа
            try {
                const tapSound = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.wav");
                tapSound.volume = 0.2;
                tapSound.play().catch(() => {}); // Без ошибки на авто-play
            } catch (e) {
                console.log("Не удалось воспроизвести звук:", e);
            }

            // 3. Быстрая анимация "scale"
            const shark = document.getElementById("tapImage");
            if (shark) {
                shark.style.transform = "scale(0.9)";
                setTimeout(() => {
                    shark.style.transform = "scale(1)";
                }, 100);
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            // --- Константы ---
            const DB_URL = "https://tralalero-fec07-default-rtdb.firebaseio.com";
            const DEFAULT_AVATAR_URL = "https://placehold.co/64x64";
            const COIN_ICON_URL = "https://sinobu1.github.io/shark-tapper/coin_icon_small.png";
            const SHARK_DEFAULT_SKIN_URL = "ww.png";
            const SHARK_SKIN2_URL = "https://sinobu1.github.io/shark-tapper/shark_skin2.png";
            const SHARK_SKIN3_URL = "https://sinobu1.github.io/shark-tapper/shark_skin1.png";
            const LOCAL_STORAGE_KEY = 'sharkTapperData';
            const SAVE_INTERVAL = 5000;
            const TAP_VIBRATION_DURATION = 50; // Увеличим длительность вибрации
            const TAP_ANIMATION_DURATION = 100;
            const TAP_EFFECT_DURATION = 600;
            const COIN_POPUP_DURATION = 1000;
            const LEADERBOARD_SIZE = 10;
            const AUTO_SAVE_INTERVAL = 30000;
            const XP_LEVEL_LIMITS = [
                0, 100, 500, 1000, 2500, 5000, 10000, 50000, 100000, 250000, 500000, 1000000, 2000000, 4000000, 8000000, 16000000, 32000000, 64000000, 100000000
            ];

            let userId = null;
            let userData = {
                username: "Player",
                avatar: DEFAULT_AVATAR_URL,
                tokens: 0,
                skin: 'default',
                level: 0,
                helpers: {} // Объект для хранения количества купленных помощников
            };
            const profileAvatar = document.getElementById('profileAvatar');
            let lastSave = 0;
            let canVibrate = 'vibrate' in navigator;
            let tapMultiplier = 1;
            let tapUpgradeCost = 50;
            const passiveIncomeInterval = 1000; // Интервал для начисления пассивного дохода (1 секунда)
            let lastPassiveIncomeTime = Date.now();

            const helpersData = {
                'tinyFish': { name: '🐟 Маленькая рыбка', description: 'Привлекает мелкие блестящие монетки.', cost: 1000, income: 1, upgradeMultiplier: 1.2 },
                'seaAnemone': { name: '🌸 Морской анемон', description: 'Фильтрует воду, находя редкие монеты.', cost: 5000, income: 5, upgradeMultiplier: 1.3 },
                'hermitCrab': { name: '🦀 Краб-отшельник', description: 'Собирает монеты, оставленные на дне.', cost: 15000, income: 15, upgradeMultiplier: 1.4 },
                'starfish': { name: '⭐ Морская звезда', description: 'Ее свет манит любопытные монетки.', cost: 50000, income: 50, upgradeMultiplier: 1.5 },
                'jellyfish': { name: '💧 Медуза', description: 'Плавно парит, собирая затерянные сокровища.', cost: 150000, income: 150, upgradeMultiplier: 1.6 },
                'babyTurtle': { name: '🐢 Черепашонок', description: 'Не спеша приносит спрятанные богатства.', cost: 500000, income: 500, upgradeMultiplier: 1.7 },
                'dolphinPup': { name: '🐬 Дельфиненок', description: 'Ловко собирает разбросанные монеты.', cost: 1500000, income: 1500, upgradeMultiplier: 1.8 },
                'smallOctopus': { name: '🐙 Маленький осьминог', description: 'Использует щупальца, чтобы найти монеты.', cost: 5000000, income: 5000, upgradeMultiplier: 1.9 },
                'friendlySeal': { name: '🦭 Дружелюбный тюлень', description: 'С радостью приносит найденные монетки.', cost: 15000000, income: 15000, upgradeMultiplier: 2.0 }
            };

            // --- Вспомогательные функции ---

            function calculateLevel(tokens) {
                for (let i = XP_LEVEL_LIMITS.length - 1; i >= 0; i--) {
                    if (tokens >= XP_LEVEL_LIMITS[i]) {
                        return i;
                    }
                }
                return 0;
            }

            function calculateTapMultiplier(tokens) {
                const max = XP_LEVEL_LIMITS.find(l => tokens < l) || 100000000;
                const level = XP_LEVEL_LIMITS.indexOf(max);
                return 1 + Math.floor(level / 5);
            }

            function updateAvatarFrameStyle(level) {
                profileAvatar.style.border = '';
                profileAvatar.style.backgroundImage = '';
                profileAvatar.style.boxShadow = '';
                profileAvatar.className = 'profile-avatar-frame';

                if (level === 0) {
                    profileAvatar.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
                } else if (level === 1) {
                    profileAvatar.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
                } else if (level >= 2) {
                    profileAvatar.classList.add('level-animated-gradient-frame');
                }
            }

            function getPassiveIncome() {
                let totalIncome = 0;
                for (const helperId in userData.helpers) {
                    if (userData.helpers.hasOwnProperty(helperId) && helpersData.hasOwnProperty(helperId)) {
                        totalIncome += userData.helpers[helperId] * helpersData[helperId].income;
                    }
                }
                return totalIncome;
            }

            function displayHelpers() {
                const helpersListUI = document.getElementById('helpersListUI');
                if (!helpersListUI) return;
                helpersListUI.innerHTML = '';

                for (const helperId in helpersData) {
                    if (helpersData.hasOwnProperty(helperId)) {
                        const helper = helpersData[helperId];
                        const owned = userData.helpers[helperId] || 0;
                        const listItem = document.createElement('li');
                        listItem.className = 'helper-item';
                        listItem.innerHTML = `
                            <div class="helper-top-info">
                                <div class="helper-emoji-frame">
                                    <span>${getHelperEmoji(helperId)}</span>
                                </div>
                                <div class="helper-name-description">
                                    <div class="helper-name">${helper.name}</div>
                                    <div class="helper-description">${helper.description}</div>
                                </div>
                            </div>
                            <div class="helper-bottom-actions">
                                <button class="buy-button ${userData.tokens < helper.cost ? 'disabled' : ''}" data-helper-id="${helperId}">
                                    Купить (${helper.cost} <img src="${COIN_ICON_URL}" alt="Coin" style="height: 12px; vertical-align: middle;">)
                                </button>
                                <div class="helper-income">
                                    <div class="income-text">
                                        <span>${helper.income} <img src="${COIN_ICON_URL}" alt="Coin" style="height: 9px; vertical-align: middle; margin-right: 0.1rem;"></span>
                                        <span style="font-size: 0.7rem;">в сек.</span>
                                    </div>
                                    <div class="owned-text">Куплено: ${owned}</div>
                                </div>
                            </div>
                        `;
                        helpersListUI.appendChild(listItem);
                    }
                }

                // Добавляем обработчики событий для кнопок "Купить"
                document.querySelectorAll('.buy-button').forEach(button => {
                    button.addEventListener('click', function() {
                        const helperId = this.dataset.helperId;
                        buyHelper(helperId);
                    });
                });
            }

            function getHelperEmoji(helperId) {
                switch (helperId) {
                    case 'tinyFish': return '🐟';
                    case 'seaAnemone': return '🌸';
                    case 'hermitCrab': return '🦀';
                    case 'starfish': return '⭐';
                    case 'jellyfish': return '💧';
                    case 'babyTurtle': return '🐢';
                    case 'dolphinPup': return '🐬';
                    case 'smallOctopus': return '🐙';
                    case 'friendlySeal': return '🦭';
                    default: return '';
                }
            }

            function buyHelper(helperId) {
                if (!helpersData.hasOwnProperty(helperId)) return;
                const helper = helpersData[helperId];
                if (userData.tokens >= helper.cost) {
                    userData.tokens -= helper.cost;
                    userData.helpers[helperId] = (userData.helpers[helperId] || 0) + 1;
                    updateDisplay();
                    displayHelpers(); // Обновляем отображение помощников после покупки
                    saveProgress();
                } else {
                    console.log("Недостаточно монет для покупки " + helper.name);
                }
            }

            // --- Инициализация ---

            function init() {
                setupEventListeners();
                loadTelegram();
                initLocalStorage();
                updateDisplay();
                showTab('home');
                displayHelpers(); // Отображаем список помощников при инициализации
                setInterval(addPassiveIncome, passiveIncomeInterval); // Запускаем интервал для пассивного дохода
            }

            function setupEventListeners() {
                const tapImage = document.getElementById('tapImage');
                tapImage.addEventListener('click', handleTap);

                const buyTapUpgradeButton = document.getElementById('buyTapUpgradeNav');
                buyTapUpgradeButton.addEventListener('click', buyTapUpgrade);

                const openHelpersModalButton = document.getElementById('openHelpersModal');
                const closeHelpersModalButton = document.getElementById('closeHelpersModal');
                const helpersModal = document.getElementById('helpersModal');

                const openSkinsModalButton = document.getElementById('openSkinsModal');
                const closeSkinsModalButton = document.getElementById('closeSkinsModal');
                const skinsModal = document.getElementById('skinsModal');

                if (openHelpersModalButton) {
                    openHelpersModalButton.addEventListener('click', () => {
                        helpersModal.style.display = "block";
                        displayHelpers(); // Загружаем список помощников при открытии модального окна
                    });
                }

                if (closeHelpersModalButton) {
                    closeHelpersModalButton.addEventListener('click', () => {
                        helpersModal.style.display = "none";
                    });
                }

                if (openSkinsModalButton) {
                    openSkinsModalButton.addEventListener('click', () => {
                        skinsModal.style.display = "block";
                    });
                }

                if (closeSkinsModalButton) {
                    closeSkinsModalButton.addEventListener('click', () => {
                        skinsModal.style.display = "none";
                    });
                }

                // Закрытие модального окна при клике вне его
                window.addEventListener('click', (event) => {
                    if (event.target === helpersModal) {
                        helpersModal.style.display = "none";
                    }
                    if (event.target === skinsModal) {
                        skinsModal.style.display = "none";
                    }
                });

                // Обработчики для скинов теперь будут и для главной страницы и для модального окна
                const skinsGallery = document.querySelectorAll('#home .shark-gallery img, #skinsModal .shark-gallery img');
                skinsGallery.forEach(img => {
                    img.addEventListener('click', function() {
                        const selectedSkin = this.dataset.skin;
                        setSkin(selectedSkin);
                        if (this.closest('#skinsModal')) {
                            skinsModal.style.display = "none"; // Закрываем модальное окно после выбора скина, если клик был в нем
                        }
                        // Обновление подсветки галереи на главной странице происходит в setSkin
                        console.log(`Скин ${selectedSkin} выбран`); // Проверка клика
                    });
                });

                const inviteFriendQuestButton = document.getElementById('inviteFriendQuest');
                const referralLinkContainer = document.getElementById('referralLinkContainer');

                if (inviteFriendQuestButton) {
                    inviteFriendQuestButton.addEventListener('click', () => {
                        if (Telegram && Telegram.WebApp) {
                            const initData = Telegram.WebApp.initDataUnsafe;
                            const userId = initData?.user?.id;
                            if (userId) {
                                const referralLink = `https://t.me/ваше_бот_имя?start=${userId}`; // Замените "ваше_бот_имя" на имя вашего Telegram-бота!
                                referralLinkContainer.innerHTML = `<p style="color: var(--primary);">Поделись этой ссылкой:</p><p><a href="${referralLink}" target="_blank">${referralLink}</a></p>`;
                                // В реальной системе вам нужно будет отслеживать переходы по этой ссылке и начисление монет.
                                // Для примера, можно просто начислить монеты сразу после нажатия кнопки (без реальной проверки).
                                userData.tokens += 100;
                                updateDisplay();
                                saveProgress();
                            } else {
                                referralLinkContainer.innerHTML = '<p style="color: var(--subtext);">Не удалось получить ID пользователя.</p>';
                            }
                        } else {
                            referralLinkContainer.innerHTML = '<p style="color: var(--subtext);">Telegram Web Apps недоступны.</p>';
                        }
                    });
                }

                document.querySelectorAll('nav button').forEach(btn => {
                    btn.addEventListener('click', function() {
                        showTab(this.dataset.tab);
                    });
                });
            }

            // --- Обработчики событий ---

            function handleTap(event) {
                feedback(); // 👈 вот она
                createTapEffect(event);
                createCoinPopup(event, tapMultiplier);
                userData.tokens += tapMultiplier;
                updateDisplay();
                const now = Date.now();
                if (now - lastSave > SAVE_INTERVAL) {
                    saveProgress();
                    lastSave = now;
                } else {
                    saveToLocalStorage();
                }
            }

            function createTapEffect(event) {
                const effect = document.createElement('div');
                effect.className = 'tap-effect';
                effect.style.left = `${event.clientX}px`;
                effect.style.top = `${event.clientY}px`;
                document.body.appendChild(effect);

                setTimeout(() => {
                    effect.remove();
                }, TAP_EFFECT_DURATION);
            }

            function createCoinPopup(event, amount) {
                const popup = document.createElement('div');
                popup.className = 'coin-popup';
                popup.innerHTML = `<img src="${COIN_ICON_URL}" alt="Coin"> +${amount}`;
                popup.style.left = `${event.clientX}px`;
                popup.style.top = `${event.clientY - 20}px`;
                document.body.appendChild(popup);

                setTimeout(() => {
                    popup.remove();
                }, COIN_POPUP_DURATION);
            }

            // --- Обновление интерфейса ---

            function updateDisplay() {
                const counter = document.getElementById("profileTokens");
                if (counter) counter.textContent = Math.floor(userData.tokens);

                const previousLevel = userData.level;
                const currentLevel = calculateLevel(userData.tokens);
                if (currentLevel > previousLevel) {
                    userData.level = currentLevel;
                    console.log(`Уровень повышен! Новый уровень: ${userData.level}`);
                    updateAvatarFrameStyle(userData.level);
                    // Здесь можно добавить логику для отображения уведомления о повышении уровня
                }

                const levelEl = document.getElementById("profileLevel");
                if (levelEl) levelEl.textContent = `Level: ${userData.level} | Coins: ${Math.floor(userData.tokens)}`;

                const bar = document.getElementById("xpBar");
                if (bar) {
                    const max = XP_LEVEL_LIMITS.find(l => userData.tokens < l) || 100000000;
                    const min = XP_LEVEL_LIMITS[XP_LEVEL_LIMITS.indexOf(max) - 1] || 0;
                    const percent = ((userData.tokens - min) / (max - min)) * 100;
                    bar.style.width = `${Math.min(100, Math.max(0, percent))}%`;
                }

                const tapMultiplierDisplay = document.getElementById('tapMultiplierDisplay');
                if (tapMultiplierDisplay) tapMultiplierDisplay.textContent = tapMultiplier;

                const buyTapUpgradeButtonNav = document.getElementById('buyTapUpgradeNav');
                if (buyTapUpgradeButtonNav) {
                    if (userData.tokens < tapUpgradeCost) {
                        buyTapUpgradeButtonNav.classList.add('disabled');
                    } else {
                        buyTapUpgradeButtonNav.classList.remove('disabled');
                    }
                }

                // Обновляем состояние кнопок покупки помощников
                const helpersListUI = document.getElementById('helpersListUI');
                if (helpersListUI) {
                    helpersListUI.querySelectorAll('.buy-button').forEach(button => {
                        const helperId = button.dataset.helperId;
                        if (userData.tokens < helpersData[helperId].cost) {
                            button.classList.add('disabled');
                        } else {
                            button.classList.remove('disabled');
                        }
                    });
                }
            }

            function showTab(tabId) {
                document.querySelectorAll('nav button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabId);
                });

                document.querySelectorAll('.tab-page').forEach(page => {
                    page.classList.toggle('active', page.id === tabId);
                });

                if (tabId === 'leaderboard') {
                    loadLeaderboard();
                }
            }

            // --- Пассивный доход ---
            function addPassiveIncome() {
                const now = Date.now();
                if (now - lastPassiveIncomeTime >= passiveIncomeInterval) {
                    const income = getPassiveIncome();
                    userData.tokens += income;
                    updateDisplay();
                    lastPassiveIncomeTime = now;
                    saveToLocalStorage(); // Сохраняем прогресс после получения пассивного дохода
                }
            }

            // --- Сохранение и загрузка данных ---

            function saveProgress() {
                if (!userId) {
                    saveToLocalStorage();
                    return;
                }

                fetch(`${DB_URL}/users/${userId}.json`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        balance: userData.tokens,
                        first_name: userData.username,
                        photo_url: userData.avatar,
                        skin: userData.skin,
                        last_update: Date.now(),
                        tapMultiplier: tapMultiplier,
                        tapUpgradeCost: tapUpgradeCost,
                        level: userData.level,
                        helpers: userData.helpers
                    })
                })
                .then(() => saveToLocalStorage())
                .catch(err => {
                    console.error('Ошибка сохранения:', err);
                    saveToLocalStorage();
                });
            }

            function initLocalStorage() {
                const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        userData.tokens = parsed.tokens || 0;
                        userData.skin = parsed.skin || 'default';
                        tapMultiplier = parsed.tapMultiplier || 1;
                        tapUpgradeCost = parsed.tapUpgradeCost || 50;
                        userData.level = parsed.level || 0;
                        userData.helpers = parsed.helpers || {};
                        updateDisplay();
                        setSkin(userData.skin, true); // Обновляем подсветку галереи
                        updateUpgradeUI();
                        updateAvatarFrameStyle(userData.level);
                        displayHelpers();
                    } catch (e) {
                        console.error('Ошибка при парсинге сохраненных данных', e);
                        userData.level = calculateLevel(userData.tokens);
                        updateDisplay();
                        updateAvatarFrameStyle(userData.level);
                        displayHelpers();
                    }
                } else {
                    userData.level = calculateLevel(userData.tokens);
                    updateDisplay();
                    updateUpgradeUI();
                    updateAvatarFrameStyle(userData.level);
                    displayHelpers();
                }
            }

            function saveToLocalStorage() {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({
                    tokens: userData.tokens,
                    skin: userData.skin,
                    tapMultiplier: tapMultiplier,
                    tapUpgradeCost: tapUpgradeCost,
                    level: userData.level,
                    helpers: userData.helpers
                }));
            }

            function loadProgress() {
                if (!userId) return;

                fetch(`${DB_URL}/users/${userId}.json`)
                    .then(res => {
                        if (!res.ok) throw new Error('Network response was not ok');
                        return res.json();
                    })
                    .then(data => {
                        if (data) {
                            const serverTokens = data.balance || 0;
                            userData.tokens = Math.max(serverTokens, userData.tokens);
                            userData.username = data.first_name || "Player";
                            userData.avatar = data.photo_url || DEFAULT_AVATAR_URL;
                            userData.skin = data.skin || 'default';
                            tapMultiplier = data.tapMultiplier || 1;
                            tapUpgradeCost = data.tapUpgradeCost || 50;
                            userData.level = data.level || calculateLevel(userData.tokens);
                            userData.helpers = data.helpers || {};
                            updateUpgradeUI();
                            updateDisplay();
                            document.getElementById("profileName").textContent = userData.username;
                            document.getElementById("profileAvatar").src = userData.avatar;
                            setSkin(userData.skin, true); // Обновляем подсветку галереи
                            saveToLocalStorage();
                            updateAvatarFrameStyle(userData.level);
                            displayHelpers();
                        } else {
                            userData.level = calculateLevel(userData.tokens);
                            updateUpgradeUI();
                            updateDisplay();
                            updateAvatarFrameStyle(userData.level);
                            displayHelpers();
                        }
                    })
                    .catch(err => {
                        console.error('Ошибка загрузки:', err);
                        userData.level = calculateLevel(userData.tokens);
                        updateUpgradeUI();
                        updateDisplay();
                        updateAvatarFrameStyle(userData.level);
                        displayHelpers();
                    });
            }

            // --- Таблица лидеров ---

            function loadLeaderboard() {
                fetch(`${DB_URL}/users.json`)
                    .then(res => {
                        if (!res.ok) throw new Error('Network response was not ok');
                        return res.json();
                    })
                    .then(data => {
                        const list = document.getElementById("leaderboardList");
                        if (!data || Object.keys(data).length === 0) {
                            return list.innerHTML = '<li style="text-align:center; color: var(--subtext);">Пока нет игроков</li>';
                        }

                        const sorted = Object.entries(data)
                            .sort((a, b) => (b[1].balance || 0) - (a[1].balance || 0))
                            .slice(0, LEADERBOARD_SIZE);

                        renderLeaderboard(sorted);
                    })
                    .catch(err => {
                        console.error('Ошибка загрузки таблицы лидеров:', err);
                        const list = document.getElementById("leaderboardList");
                        list.innerHTML = '<li style="text-align:center; color: var(--subtext);">Ошибка загрузки</li>';
                    });
            }

            function renderLeaderboard(data) {
                const list = document.getElementById("leaderboardList");
                list.innerHTML = data.map(([id, user], i) => {
                    const isCurrentUser = id === userId?.toString();
                    return `
                                <li class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
                                    <span style="font-weight: bold; color: var(--primary); width: 24px; text-align: center;">#${i + 1}</span>
                                    <img src="${user.photo_url || DEFAULT_AVATAR_URL}"
                                         style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--accent); object-fit: cover;">
                                    <span style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${user.first_name || 'Player'}
                                    </span>
                                    <span style="color: var(--subtext); font-family: 'Press Start 2P', cursive; font-size: 0.7rem;">
                                        ${user.balance || 0} 💰
                                    </span>
                                </li>`;
                }).join("");
            }

            // --- Скины ---

            function setSkin(skin, silent = false) {
                const skins = {
                    'default': SHARK_DEFAULT_SKIN_URL,
                    'skin2': SHARK_SKIN2_URL,
                    'skin3': SHARK_SKIN3_URL
                };

                if (skins[skin]) {
                    userData.skin = skin;
                    document.getElementById('tapImage').src = skins[skin];
                    if (!silent) saveProgress();

                    // Обновляем подсветку в галерее скинов на главной странице
                    const galleryImages = document.querySelectorAll('#home .shark-gallery img');
                    galleryImages.forEach(img => {
                        if (img.dataset.skin === skin) {
                            img.style.border = '2px solid var(--accent)'; // Или другой стиль подсветки
                        } else {
                            img.style.border = '2px solid var(--primary)'; // Возвращаем стандартный стиль
                        }
                    });
                }
            }

            // --- Интеграция с Telegram Web Apps ---

            function loadTelegram() {
                const tgUser = Telegram?.WebApp?.initDataUnsafe?.user;
                if (tgUser) {
                    userId = tgUser.id?.toString();
                    userData.username = tgUser.first_name || "Player";
                    userData.avatar = tgUser.photo_url || DEFAULT_AVATAR_URL;
                    document.getElementById("profileName").textContent = userData.username;
                    document.getElementById("profileAvatar").src = userData.avatar;
                    loadProgress();
                } else {
                    document.getElementById("profileName").textContent = "Player";
                    initLocalStorage();
                    updateDisplay();
                    updateAvatarFrameStyle(userData.level);
                    displayHelpers();
                }
            }

            // --- Автоматическое сохранение ---

            setInterval(() => {
                if (userData.tokens > 0) {
                    saveProgress();
                }
            }, AUTO_SAVE_INTERVAL);

            // --- Функция покупки улучшения тапа ---
            function buyTapUpgrade() {
                if (userData.tokens >= tapUpgradeCost) {
                    userData.tokens -= tapUpgradeCost;
                    tapMultiplier++;
                    tapUpgradeCost = Math.round(tapUpgradeCost * 1.5);
                    updateDisplay();
                    updateUpgradeUI();
                } else {
                    console.log("Недостаточно монет!");
                }
            }

            // --- Функция обновления UI улучшения ---
            function updateUpgradeUI() {
                const tapUpgradeCostElementNav = document.getElementById('tapUpgradeCostNav');
                if (tapUpgradeCostElementNav) tapUpgradeCostElementNav.textContent = tapUpgradeCost;
            }

            // --- Запуск приложения ---
            init();
        });
    </script>
</body>
</html>
