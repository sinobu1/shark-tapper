<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- Установка кодировки и масштабирования -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Shark Tapper</title>

  <!-- Скрипт для интеграции с Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- CSS стили -->
  <style>
    /* Стили для загрузочного экрана */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-screen img {
      width: 100px;
      height: auto;
      margin-bottom: 20px;
    }

    /* Контейнер основной игры */
    .game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #e0f7fa;
      position: relative;
    }

    /* Баланс токенов */
    .balance {
      font-size: 24px;
      margin-bottom: 20px;
    }

    /* Изображение для нажатия (акула) */
    .tap-image {
      width: 150px;
      height: auto;
      cursor: pointer;
    }

    /* Кнопки меню */
    .menu-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .shop-button {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      border-radius: 5px;
    }

    .shop-button:hover {
      background-color: #45a049;
    }

    /* Стили для магазина */
    .shop-modal, .booster-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
    }

    .shop-modal img, .booster-modal div {
      margin: 10px;
    }

    /* Анимация +1 */
    .floating-text {
      position: absolute;
      animation: floatUp 1s ease-out forwards;
      color: #388e3c;
      font-weight: bold;
      pointer-events: none;
    }

    @keyframes floatUp {
      0% {
        transform: translateY(0);
        opacity: 1;
      }
      100% {
        transform: translateY(-50px);
        opacity: 0;
      }
    }

    /* Лидерборд */
    .leaderboard {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <!-- Загрузочный экран -->
  <div class="loading-screen" id="loading">
    <img src="w1.png" alt="Loading..." />
    <span>Приключение 2025</span>
  </div>

  <!-- Основной игровой интерфейс -->
  <div class="game-container" style="display:none" id="gameContainer">
    <!-- Баланс токенов -->
    <div class="balance" id="tokenCount">0 токенов</div>

    <!-- Активная область клика (акула) -->
    <img id="tapImage" class="tap-image" src="" onclick="handleTap()" alt="Shark" />

    <!-- Кнопки магазина и бустеров -->
    <div class="menu-buttons">
      <button class="shop-button" onclick="openShop()">Магазин</button>
      <button class="shop-button" onclick="openBoosters()">Бустеры</button>
    </div>

    <!-- Кнопка завершения сессии -->
    <button class="shop-button" id="endButton" onclick="Telegram.WebApp.close()" style="display: none;">Завершить</button>
  </div>

  <!-- Модалка магазина скиннов -->
  <div id="shop-modal" class="shop-modal">
    <h2>Магазин скинов</h2>
    <div>
      <img src="s1.png" onclick="buySkin('s1')">
      <button onclick="buySkin('s1')">Купить за 100</button>
    </div>
    <div>
      <img src="s2.png" onclick="buySkin('s2')">
      <button onclick="buySkin('s2')">Купить за 200</button>
    </div>
    <button onclick="closeShop()">Закрыть</button>
  </div>

  <!-- Модалка бустеров -->
  <div id="booster-modal" class="booster-modal">
    <h2>Бустеры</h2>
    <div><button onclick="buyBooster(1)">+1/сек за 50</button></div>
    <div><button onclick="buyBooster(2)">+2/сек за 100</button></div>
    <div><button onclick="buyBooster(3)">+5/сек за 300</button></div>
    <button onclick="closeBoosters()">Закрыть</button>
  </div>

  <!-- Лидерборд -->
  <div class="leaderboard" id="leaderboard">
    <h3>Топ игроков</h3>
    <ul id="leaderboardList"></ul>
  </div>

  <!-- Скрипт логики игры -->
  <script>
    // Инициализация переменных
    const dbUrl = 'https://tralalero-fec07-default-rtdb.firebaseio.com';
    let currentSkin = 'default';
    let balance = 0;
    let ownedSkins = { default: true };
    let autoTap = 0;
    let ownedBoosters = { 1: false, 2: false, 3: false };
    let userId = null;

    // DOM элементы
    const tokenCount = document.getElementById('tokenCount');
    const tapImage = document.getElementById('tapImage');
    const gameContainer = document.getElementById('gameContainer');
    const loadingScreen = document.getElementById('loading');

    // Обновление скина акулы
    function updateSkin() {
      tapImage.src = currentSkin + '.png';
    }

    // Сохранение прогресса в Firebase
    function saveProgress() {
      fetch(`${dbUrl}/users/${userId}.json`, {
        method: 'PUT',
        body: JSON.stringify({ balance, ownedSkins, currentSkin, autoTap })
      });
    }

    // Загрузка прогресса из Firebase
    function loadProgress() {
      fetch(`${dbUrl}/users/${userId}.json`)
        .then(response => response.json())
        .then(data => {
          if (data) {
            balance = data.balance || 0;
            ownedSkins = data.ownedSkins || { default: true };
            currentSkin = data.currentSkin || 'default';
            autoTap = data.autoTap || 0;
            tokenCount.innerText = `${balance} токенов`;
            updateSkin();
          }
        });
    }

    // Загрузка и отображение таблицы лидеров
    function loadLeaderboard() {
      fetch(`${dbUrl}/users.json`)
        .then(response => response.json())
        .then(data => {
          const users = Object.entries(data || {}).map(([id, info]) => ({ id, balance: info.balance || 0 }));
          users.sort((a, b) => b.balance - a.balance);
          const leaderboard = document.getElementById('leaderboardList');
          leaderboard.innerHTML = '';
          users.slice(0, 10).forEach(user => {
            const li = document.createElement('li');
            li.innerText = `Игрок ${user.id.slice(-4)}: ${user.balance}`;
            leaderboard.appendChild(li);
          });
        });
    }

    // Показываем +1 при нажатии
    function showFloatingText(text) {
      const floatingText = document.createElement('div');
      floatingText.className = 'floating-text';
      floatingText.innerText = text;
      floatingText.style.left = (tapImage.offsetLeft + 75) + 'px';
      floatingText.style.top = (tapImage.offsetTop + 20) + 'px';
      document.body.appendChild(floatingText);
      setTimeout(() => floatingText.remove(), 1000);
    }

    // Обработка клика по акуле
    function handleTap() {
      balance++;
      tokenCount.innerText = `${balance} токенов`;
      showFloatingText('+1');
      saveProgress();
    }

    // Магазин: открыть/закрыть/покупка скина
    function openShop() {
      document.getElementById('shop-modal').style.display = 'flex';
    }

    function closeShop() {
      document.getElementById('shop-modal').style.display = 'none';
    }

    function buySkin(skin) {
      const cost = skin === 's1' ? 100 : skin === 's2' ? 200 : 0;
      if (ownedSkins[skin] || balance >= cost) {
        if (!ownedSkins[skin]) balance -= cost;
        ownedSkins[skin] = true;
        currentSkin = skin;
        updateSkin();
        tokenCount.innerText = `${balance} токенов`;
        saveProgress();
      } else {
        alert('Недостаточно токенов');
      }
    }

    // Бустеры: открыть/закрыть/покупка
    function openBoosters() {
      document.getElementById('booster-modal').style.display = 'flex';
    }

    function closeBoosters() {
      document.getElementById('booster-modal').style.display = 'none';
    }

    function buyBooster(level) {
      const costs = { 1: 50, 2: 100, 3: 300 };
      const boosts = { 1: 1, 2: 2, 3: 5 };
      if (!ownedBoosters[level] && balance >= costs[level]) {
        balance -= costs[level];
        autoTap += boosts[level];
        ownedBoosters[level] = true;
        tokenCount.innerText = `${balance} токенов`;
        saveProgress();
      } else {
        alert('Недостаточно токенов или уже куплено');
      }
    }

    // Автоматическое добавление токенов
    function startAutoTap() {
      setInterval(() => {
        if (autoTap > 0) {
          balance += autoTap;
          tokenCount.innerText = `${balance} токенов`;
          saveProgress();
        }
      }, 1000);
    }

    // Запуск при загрузке страницы
    window.addEventListener('DOMContentLoaded', () => {
      loadingScreen.style.display = 'none';
      gameContainer.style.display = 'flex';
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      userId = Telegram.WebApp.initDataUnsafe?.user?.id?.toString();
      if (userId) {
        loadProgress();
        startAutoTap();
        loadLeaderboard();
      } else {
        alert("Не удалось получить userId из Telegram Web App.");
      }
    });
  </script>
</body>
</html>
